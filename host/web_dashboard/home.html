<!DOCTYPE html>
<html data-bs-theme="dark">

<head>
    <title>NHP Synth Home</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=800, height=480, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/bootstrap-icons-1.11.0/bootstrap-icons.css">
    <link rel="stylesheet" href="static/css/style.css">
    <script src="static/js/bundles/socket.io.min.js"></script>
    <script src="static/js/bundles/bootstrap.bundle.min.js"></script>
    <script src="static/js/bundles/chart.umd.min.js"></script>
</head>

<body>
    <script type="module" src="static/js/globals.js"></script>
    <script type="module">

        // --- Offcanvas State Persistence ---
        setOpenOffcanvasId(null);
        setSelectedId(null);

        // Listen for offcanvas open/close events
        function setupStateListeners() {
            // Offcanvas listeners
            document.querySelectorAll('.offcanvas').forEach(offcanvas => {
                offcanvas.addEventListener('show.bs.offcanvas', function () {
                    setOpenOffcanvasId(this.id);
                });
                offcanvas.addEventListener('hide.bs.offcanvas', function () {
                    if (getOpenOffcanvasId() === this.id) {
                        setOpenOffcanvasId(null);
                    }
                });
            });

            // Input group selection listeners
            document.querySelectorAll('.selectable').forEach(element => {
                element.addEventListener('click', function () {
                    const currentId = getSelectedId();
                    if (currentId === this.id) {
                        setSelectedId(null); // Deselect if already selected
                    } else {
                        setSelectedId(this.id); // Select this group
                        // Deselect other groups
                        document.querySelectorAll('.selectable').forEach(otherSelectable => {
                            if (otherSelectable !== this) {
                                otherSelectable.classList.remove('selected');
                            }
                        });
                        this.classList.add('selected');
                    }
                });
            });
        }

        // --- Render Logic ---
        function render() {
            // Synth cards
            const cardsContainer = document.getElementById('synth-cards');
            if (cardsContainer) {
                if (AppState.synthState && AppState.synthState.synths) {
                    cardsContainer.innerHTML = SynthCards(AppState);
                    // After DOM update, render combined waveforms for each synth
                    AppState.synthState.synths.forEach((synth, idx) => {
                        singlePhaseWaveformChart(synth, `waveform_single_phase_${idx}`);
                    });
                    // Render the single three-phase waveform (requires all synths)
                    if (AppState.synthState.synths.length >= 3) {
                        threePhaseWaveformChart(AppState.synthState.synths, `waveform_three_phase`);
                    }
                    console.log(AppState);

                    // Restore selected input group if any
                    if (AppState.selectedId) {
                        const selectedId = document.getElementById(AppState.selectedId);
                        if (selectedId) {
                            selectedId.classList.add('selected');
                        }
                    }

                    // Restore open offcanvas if any, but only disable animation for this restoration
                    if (AppState.openOffcanvasId) {
                        const offcanvasElem = document.getElementById(AppState.openOffcanvasId);
                        if (offcanvasElem && !offcanvasElem.classList.contains('show')) {
                            // Temporarily disable transition for this element
                            const prevTransition = offcanvasElem.style.transition;
                            offcanvasElem.style.transition = 'none';
                            // Use Bootstrap's Offcanvas API to show
                            const bsOffcanvas = bootstrap.Offcanvas.getOrCreateInstance(offcanvasElem);
                            bsOffcanvas.show();
                            // Force reflow to apply the class immediately
                            void offcanvasElem.offsetWidth;
                            // Restore transition after a short delay
                            setTimeout(() => {
                                offcanvasElem.style.transition = prevTransition;
                            }, 10);
                        }
                    }

                    setupStateListeners();
                } else {
                    cardsContainer.innerHTML = LoadingSpinner();
                }
            }
        }

        // --- Socket.IO and Event Logic ---
        const socket = io();
        setSocket(socket);
        socket.on('synthState', function (data) {
            if (!synthStateEquals(AppState.synthState, data)) {
                // Assign synthetic id if missing
                if (data && Array.isArray(data.synths)) {
                    data.synths.forEach((synth, idx) => {
                        if (typeof synth.id === 'undefined') {
                            synth.id = idx;
                        }
                    });
                }
                AppState.synthState = data;
                render();
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            render();
            const fsBtn = document.getElementById('fullscreen-btn');
            if (fsBtn) {
                fsBtn.addEventListener('click', toggleFullscreen);
            }
            // Optionally update icon/text on fullscreen change
            function updateFullscreenIcon() {
                const icon = document.getElementById('fullscreen-icon');
                if (!icon) return;
                if (document.fullscreenElement) {
                    icon.innerHTML = '<span class="bi bi-fullscreen-exit"></span>'; // Exit fullscreen icon
                } else {
                    icon.innerHTML = '<span class="bi bi-fullscreen"></span>'; // Fullscreen icon
                }
            }
            document.addEventListener('fullscreenchange', updateFullscreenIcon);
            document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
            document.addEventListener('mozfullscreenchange', updateFullscreenIcon);
            document.addEventListener('MSFullscreenChange', updateFullscreenIcon);
        });

        // --- Fullscreen Toggle Logic ---
        function toggleFullscreen() {
            const doc = window.document;
            const docEl = doc.documentElement;
            if (!doc.fullscreenElement && !doc.webkitFullscreenElement && !doc.mozFullScreenElement && !doc.msFullscreenElement) {
                if (docEl.requestFullscreen) {
                    docEl.requestFullscreen();
                } else if (docEl.mozRequestFullScreen) {
                    docEl.mozRequestFullScreen();
                } else if (docEl.webkitRequestFullscreen) {
                    docEl.webkitRequestFullscreen();
                } else if (docEl.msRequestFullscreen) {
                    docEl.msRequestFullscreen();
                }
            } else {
                if (doc.exitFullscreen) {
                    doc.exitFullscreen();
                } else if (doc.mozCancelFullScreen) {
                    doc.mozCancelFullScreen();
                } else if (doc.webkitExitFullscreen) {
                    doc.webkitExitFullscreen();
                } else if (doc.msExitFullscreen) {
                    doc.msExitFullscreen();
                }
            }
        }
    </script>
    <div class="d-flex justify-content-center align-items-center min-vh-100">
        <div class="container-fluid bg-secondary rounded shadow overflow-hidden" style="width:800px; height:480px;">
            <div class="row bg-dark mb-2 align-items-center" style="min-height:38px;">
                <div class="col text-end">
                    <button class="btn btn-sm btn-outline-light me-2" onclick="window.location.reload()"
                        title="Force Refresh">
                        <span class="bi bi-arrow-clockwise"></span>
                    </button>
                    <button class="btn btn-sm btn-outline-light" id="fullscreen-btn" title="Toggle Fullscreen">
                        <span id="fullscreen-icon"><span class="bi bi-fullscreen"></span></span>
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col" id="synth-cards">
                    <!-- Synth cards will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>
</body>

</html>